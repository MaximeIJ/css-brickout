var M=Object.defineProperty;var P=(l,t,e)=>t in l?M(l,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):l[t]=e;var a=(l,t,e)=>(P(l,typeof t!="symbol"?t+"":t,e),e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&i(o)}).observe(document,{childList:!0,subtree:!0});function e(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(s){if(s.ep)return;s.ep=!0;const n=e(s);fetch(s.href,n)}})();class p{constructor({parent:t,elementId:e,className:i,x:s,y:n,width:o=0,height:d=0}){a(this,"x");a(this,"y");a(this,"width");a(this,"height");a(this,"element");a(this,"parent");this.x=s,this.y=n,this.width=o,this.height=d,this.parent=t,this.element=document.createElement("div"),e&&(this.element.id=e),o&&(this.element.style.width=`${o}%`),d&&(this.element.style.height=`${d}%`),i&&this.element.classList.add(...i.split(" ")),t.appendChild(this.element),this.updateElementPosition()}updatePosition(t,e){this.x=t??this.x,this.y=e??this.y}updateElementPosition(){const{offsetWidth:t,offsetHeight:e}=this.parent,i=Math.round(this.x/100*t),s=Math.round(this.y/100*e);this.element.style.transform=`translateX(calc(${i}px - 50%)) translateY(calc(${s}px - 50%))`}setStyle(t,e){this.element.style[t]=e}setContent(t){this.element.innerHTML=t}destroy(){this.element.remove()}}class L extends p{constructor({idx:e,radius:i,angle:s,speed:n,...o}){super({...o,className:[...o.className??[],"ball"].join(" "),elementId:`ball-${e}`});a(this,"destroyed",!1);a(this,"radius");a(this,"speed");a(this,"angle");this.radius=i,this.angle=s,this.speed=n;const d=Math.round(this.radius/100*this.parent.offsetHeight);this.element.style.setProperty("--diameter",d*2+"px")}updatePosition(){super.updatePosition(this.x+this.speed*Math.cos(this.angle),this.y-this.speed*Math.sin(this.angle))}handleLevelCollision(e,i){const s=this.handleBoundaryCollision(e);let n=!1,o=0;for(;o<e.bricks.length&&!n;){let d=0;for(;d<e.bricks[o].length&&!n;){const h=e.bricks[o][d];if(d++,!h.destroyed&&this.isColliding(h)){n=!0;const r=h.x+h.width/2-this.x,m=h.y-h.height/2-this.y;console.log("deltaX",r,"deltaY",m);const c=Math.abs(h.x-(this.x+this.radius)),u=Math.abs(h.x+h.width-(this.x+this.radius)),g=Math.abs(h.y-(this.y+this.radius)),f=Math.abs(h.y+h.height-(this.y+this.radius)),b=this.x,v=this.y,y=this.angle;Math.min(c,u)>Math.min(g,f)?(console.log("side hit brick",h.y,h.x,f,g,c,u),this.angle=Math.atan2(this.speed*Math.sin(this.angle),-this.speed*Math.cos(this.angle)),this.updatePosition(),this.isColliding(h)&&(console.warn("side hit was wrong, switching to vertical",this.angle),this.angle=Math.atan2(-this.speed*Math.sin(y),this.speed*Math.cos(y))),this.x=b,this.y=v):(console.log("vert hit brick",h.y,h.x,f,g,c,u),this.angle=Math.atan2(-this.speed*Math.sin(this.angle),this.speed*Math.cos(this.angle)),this.updatePosition(),this.isColliding(h)&&(console.warn("vertical hit was wrong, switching to side",this.angle),this.angle=Math.atan2(this.speed*Math.sin(y),-this.speed*Math.cos(y))),this.x=b,this.y=v),h.destroy(),e.onBrickDestroyed(h)}}o++}n||s||this.handlePaddleCollision(i),this.updatePosition(),this.updateElementPosition()}handleBoundaryCollision(e){if(this.x-this.radius<=0||this.x+this.radius>=100)return this.angle=Math.PI-this.angle,!0;if(this.y-this.radius<=0)return this.angle=-this.angle,!0;if(this.y+this.radius>=100)return this.speed/=1.5,this.destroy(),e.onBallLost(),!0}handlePaddleCollision(e){const i=e.y-e.height/2;if(this.isColliding(e)){const n=(this.x-e.x)/(e.width/2),o=this.angle,h=n*.4,r=-(o+h);return this.y=i-this.radius,this.angle=r,!0}}isColliding(e){const i=e.y-e.height/2,s=e.y+e.height/2,n=e.x-e.width/2,o=e.x+e.width/2;return this.x+this.radius>n&&this.x-this.radius<o&&this.y+this.radius>i&&this.y-this.radius<s}destroy(){setTimeout(()=>{super.destroy()},350),this.element.classList.add("ball--destroyed"),this.destroyed=!0}}class E extends p{constructor({x:e=50,y:i=50,onClick:s,...n}){super({...n,x:e,y:i,className:[n.className??"","clickable"].join(" ")});a(this,"onClick");this.onClick=s,this.element.addEventListener("click",()=>this.onClick())}destroy(){this.parent.removeEventListener("click",()=>this.onClick()),super.destroy()}}class x extends p{constructor({elementId:t="debug",x:e=50,y:i=95,...s}){super({elementId:t,x:e,y:i,...s})}}class k extends p{constructor(e){super({...e,className:[...e.className??[],"brick"].join(" ")});a(this,"destroyed",!1)}destroy(){setTimeout(()=>{super.destroy()},300),this.element.classList.add("brick--destroyed"),this.destroyed=!0}}class C{constructor({cols:t,height:e,rows:i,y:s,parent:n,onBallLost:o,onBrickDestroyed:d}){a(this,"bricks");a(this,"left");a(this,"onBallLost");a(this,"onBrickDestroyed");this.bricks=[];let h=0;for(let r=0;r<i;r++){const m=[],c=100/t;for(let u=0;u<t;u++)m.push(new k({parent:n,width:c,height:e,x:c*(u+.5),y:s+e*r,elementId:`brick-${r*t+u}`})),h++;this.bricks.push(m)}this.left=h,this.onBallLost=o,this.onBrickDestroyed=r=>{this.left--,d(r)}}updateElementPositions(){this.bricks.forEach(t=>{t.forEach(e=>{e.updateElementPosition()})})}isDone(){return this.left===0}}class B extends p{constructor(t){super({...t,className:[...t.className??[],"paddle"].join(" ")}),this.parent.addEventListener("mousemove",e=>this.handleMouseMove(e)),this.parent.addEventListener("touchmove",e=>this.handleTouchMove(e),{passive:!0})}handleMouseMove(t){const i=t.clientX/this.parent.offsetWidth*100;this.updatePosition(i)}handleTouchMove(t){const s=t.touches[0].clientX/window.innerWidth*100;this.updatePosition(s)}destroy(){this.parent.removeEventListener("mouseover",t=>this.handleMouseMove(t)),this.parent.removeEventListener("touchmove",t=>this.handleTouchMove(t)),super.destroy()}}class T extends p{constructor({elementId:t="pause",x:e=50,y:i=50,...s}){super({elementId:t,x:e,y:i,...s})}}const w=["playing","debug"],D=["paused","away"];class N{constructor(t){a(this,"element");a(this,"state","starting");a(this,"lastFrameTime",Date.now());a(this,"lastFpsUpdate",Date.now());a(this,"balls",[]);a(this,"level");a(this,"paddle");a(this,"debug");a(this,"paused");a(this,"resumeLink");a(this,"debounceTimer");this.element=document.getElementById(t.parentId??"game"),this.paddle=new B({...t.paddleConfig,parent:this.element,elementId:"paddle",x:50,y:89}),this.debug=null,this.paused=null,this.resumeLink=null,this.level=new C({...t.levelConfig,parent:this.element,onBallLost:()=>this.onBallLost(),onBrickDestroyed:e=>this.onBrickDestroyed(e)}),t.ballConfigs.forEach((e,i)=>{const s=new L({...e,idx:i,parent:this.element});this.balls.push(s)}),document.addEventListener("visibilitychange",()=>this.handleVisibilityChange()),document.addEventListener("keydown",e=>this.handleKeyPress(e)),this.element.addEventListener("mouseenter",()=>this.handleMouseEnter()),this.element.addEventListener("mouseleave",()=>this.handleMouseLeave()),new ResizeObserver(()=>this.handleResize()).observe(this.element)}debounce(t,e=500){return()=>{clearTimeout(this.debounceTimer),this.debounceTimer=setTimeout(()=>{t.apply(this)},e)}}start(){this.createdPausedElement("Start")}update(){if(w.includes(this.state)){this.debug&&this.updateDebug(),this.paddle.updateElementPosition();for(const t of this.balls)if(t.handleLevelCollision(this.level,this.paddle),this.debug&&t.y>this.paddle.y-this.paddle.height&&t.y<this.paddle.y){console.log(t.element.id+" is near paddle");const e=Math.round(t.x-this.paddle.width/2+Math.random()*this.paddle.width/2);this.paddle.updatePosition(e)}requestAnimationFrame(()=>this.update())}}onBallLost(){this.balls=this.balls.filter(t=>!t.destroyed),this.balls.length===0&&(this.state="lost",this.createdPausedElement("Game Over","final"))}onBrickDestroyed(t){this.level.isDone()&&(this.state="won",this.createdPausedElement("Victory!","final"))}updateDebug(){var i;const t=Date.now(),e=1e3/(t-this.lastFrameTime);this.lastFrameTime=t,t>this.lastFpsUpdate+1e3&&((i=this.debug)==null||i.setContent(`FPS: ${e.toFixed(0)} | ${this.state}`),this.lastFpsUpdate=t)}handleResize(){var t,e,i;this.paddle.updateElementPosition(),this.balls.forEach(s=>s.updateElementPosition()),this.level.updateElementPositions(),(t=this.paused)==null||t.updateElementPosition(),(e=this.resumeLink)==null||e.updateElementPosition(),(i=this.debug)==null||i.updateElementPosition(),console.log("resize")}handleVisibilityChange(){document.hidden?this.pause("away"):this.resume("away")}handleKeyPress(t){switch(t.code){case"KeyP":case"Space":this.state==="starting"?this.resume("starting"):this.paused?this.resume():this.pause();break;case"KeyD":this.debug?(this.debug.destroy(),this.debug=null,this.state==="debug"&&(this.state="playing")):(this.debug=new x({parent:this.element}),this.state="debug");break}}handleMouseEnter(){this.debounceTimer&&this.debounce(()=>this.resume("away"),1e3)()}handleMouseLeave(){this.debounce(()=>{this.pause("away")})()}createdPausedElement(t,e=""){var i,s;(i=this.paused)==null||i.destroy(),(s=this.resumeLink)==null||s.destroy(),this.paused=new T({parent:this.element,className:e}),this.resumeLink=new E({parent:this.paused.element,className:"resume-link",onClick:()=>this.resume(this.state==="starting"?"starting":void 0)}),this.resumeLink.setContent(t)}pause(t){var e;w.includes(this.state)&&(this.createdPausedElement(t==="away"?"Away":"Resume"),this.state=t??"paused",(e=this.debug)==null||e.setContent(this.state))}resume(t){var e;(t?t===this.state:D.includes(this.state))&&((e=this.paused)==null||e.destroy(),this.paused=null,this.state=this.debug?"debug":"playing",this.update())}destroy(){document.removeEventListener("visibilitychange",()=>this.handleVisibilityChange()),document.removeEventListener("keydown",t=>this.handleKeyPress(t)),this.element.removeEventListener("mouseenter",()=>this.handleMouseEnter()),this.element.removeEventListener("mouseleave",()=>this.handleMouseLeave())}}const X=-Math.PI/2.001,F={x:50,y:35,radius:.5,speed:.45},O={ballConfigs:[{...F,angle:X}],levelConfig:{y:10,rows:4,cols:20,height:3},paddleConfig:{width:8.9,height:1}},R=new N(O);R.start();
